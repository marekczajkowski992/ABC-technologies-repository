pipeline {
  agent any	
 
  stages{
    stage('Code build'){
      steps{
        sh 'mvn clean install'
      }
    }
    stage('Code compiling'){
      steps{
        sh 'mvn compile'
      }
    }
    stage('Code testing'){
      steps{
        sh 'mvn test'
      }
    }
    stage('Code packing'){
      steps{
        sh 'mvn package'
      }
    }
    stage('Run Ansible Playbook') {
      steps {
        sshagent(['7e1ef070-124b-43fe-9b24-1db404fcc542']) {
          sh 'scp abc-container-deploy.yml docker-compose.yml ec2-user@13.49.70.211:/tmp/ && ssh ec2-user@13.49.70.211 "ansible-playbook abc-container-deploy.yml"'
        }
      }
    }    
    stage ('Push Docker Image'){
      steps{
        withDockerRegistry ([ credentialsId: "mydockerhubcred", url: ""]){
          sh 'docker push marekczajkowski992/abctech:latest'
        }
      }
    }
  }
}
